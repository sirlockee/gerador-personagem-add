
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <title>Advanced Dungeon & Dragons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="icon" href="img/favicon.gif">
    <style>
      html {
        width: 100%;
        box-sizing: border-box;
      }
      body {
        padding: 10px;
        margin: 0;
        border: 0;
        width: 100%;
        box-sizing: border-box;

        font-family: Consolas, "Lucida Console", Courier, mono !important;
        font-size: 12px !important;
        color: rgb(34, 34, 34) !important;
      }
      header {
        width: 100%;
        display: block;
        box-sizing: border-box;
      }
      header img {
        max-width: 300px;
        display: block;
        margin: 0 auto;
      }
      div {
        width: auto !important;
        display: block;
        box-sizing: border-box;
      }
      table {
        width: auto !important;
      }
      thead tr th {
        display: none;
      }
      td {
        font-size: 0.9em !important;
      }
      tbody tr td:first-child {
        font-weight: bold;
        width: auto !important;
        border: 0 !important;
      }
      tbody tr td tbody tr td tbody tr td:last-child {
        background-color: #eee !important;
        border: 0 !important;
      }
      tbody tr:nth-child(4) td tbody tr td:last-child {
        background-color: #eee !important;
        border: 0 !important;
      }
      tbody tr:nth-child(6) td tbody tr td:last-child {
        background-color: #eee !important;
        border: 0 !important;
        white-space: normal !important;
      }
      tbody tr:nth-child(7) td tbody tr td:last-child {
        background-color: #eee !important;
        border: 0 !important;
        white-space: normal !important;
      }
      td {
        max-width: 320px !important;
      }
      #botao {
        padding: 5px;
        margin-bottom: 10px;
        background-color: #eee;
        width: 100% !important;
      }
      #ficha {
        margin-bottom: 30px;
      }
      button {
        background-color: #ddd;
      }
    </style>
  </head>
  <body>

    <header>
      <img src="img/logo.gif" />
    </header>
    <div id="botao">
      Clique no botão para gerar/copiar a URL deste personagem e compartilhar com outros jogadores. Ela estará salva na área de transferência do seu celular/computador.
      <br /><br />
      <button type="button">Copiar URL para compartilhar personagem</button>
      <span></span>
    </div>
    <div id="ficha"></div>

    <script src="scripts/prettyprint.js"></script>
    <script type="text/javascript">

      function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          var successful = document.execCommand('copy');
          var msg = successful ? 'successful' : 'unsuccessful';
          console.log('Fallback: Copying text command was ' + msg);
        } catch (err) {
          console.error('Fallback: Oops, unable to copy', err);
        }

        document.body.removeChild(textArea);
      }

      function copyTextToClipboard(text, callback) {
        if (!navigator.clipboard) {
          fallbackCopyTextToClipboard(text);
          return;
        }
        navigator.clipboard.writeText(text).then(function() {
          console.log('Async: Copying to clipboard was successful!');
          callback(true);
        }, function(err) {
          console.error('Async: Could not copy text: ', err);
          callback(false);
        });
      }

      document.querySelector("div#botao > button").addEventListener("click", evento => {
        let url = window.location.href;
        copyTextToClipboard(url, resultado => {
          let msg = "URL copiada!";
          if (!resultado) msg = "Houve um problema para copiar a URL!";
          document.querySelector("div#botao > span").textContent = msg;
        });
      });

      const RACAS = {
        "Humano": {
          "Força": { minimo: 3, maximo: 18 },
          "Destreza": { minimo: 3, maximo: 18 },
          "Constituição": { minimo: 3, maximo: 18 },
          "Inteligência": { minimo: 3, maximo: 18 },
          "Sabedoria": { minimo: 3, maximo: 18 },
          "Carisma": { minimo: 3, maximo: 18 },
          ajustes: {},
          detalhes: [
            'Humanos podem ser de qualquer classe e alcançar qualquer nível na classe escolhida'
          ],
          altura: { "Masculino": { minimo: 1.52, maximo: 2.02 }, "Feminino": { minimo: 1.5, maximo: 2.0 }},
          idade: { minimo: 15, maximo: 130 },
          peso: { "Masculino": { minimo: 70, maximo: 100 }, "Feminino": { minimo: 50, maximo: 80 }},
          linguas_importantes: [ "comum" ],
          linguas: [ 'élfico', 'do anões', 'dos gnomos', 'dos halflings', 'dos goblins', 'dos robgoblins', 'dos orcs', 'dos gnolls' ],
          armas_importantes: []
        },
        "Anão": {
          "Força": { minimo: 8, maximo: 18 },
          "Destreza": { minimo: 3, maximo: 17 },
          "Constituição": { minimo: 11, maximo: 18 },
          "Inteligência": { minimo: 3, maximo: 18 },
          "Sabedoria": { minimo: 3, maximo: 18 },
          "Carisma": { minimo: 3, maximo: 17 },
          ajustes: { "Constituição": 1, "Carisma": -1 },
          detalhes: [
            'Possuem um bônus de resistência (+1 para cada 3½ pontos de Constituição) contra ataques de varinhas de condão, bastão mágicos, cajados e outras magias.',
            'Possuem resistência excepcional a substâncias tóxicas. Seus testes de resistência contra veneno possuem bônus +1 para cada 3½ pontos de Constituição.',
            'Itens mágicos que não forem especificamente compatíveis com a classe do personagem têm 20% de chance falhar quando usados por um anão. O teste de falha aplica-se a bastões, varinhas, anéis, amuletos, poções, trombetas e todos os outros tipos de ltens mágicos, exceto armas, escudos, armaduras, manoplas e faixas. Esta penalidade não se aplica a anões clérigos usando itens de sua classe. Se falhar, é possível perceber se o item é amaldiçoado.',
            'Em combate corpo a corpo, os anões adicionam 1 à jogada de ataque feita contra ogros, meio-ogros, goblins e robgoblins.',
            'Quando ogros, trolls, ogros magos, gigantes ou titãs atacam os anões, estes monstros precisam subtrair 4 pontos de suas jogadas de ataque.',
            'A infravisão dos anões tem um alcance de 20 metros no escuro.',
            'Estando a 3 metros, o Anão pode detectar (1-5 em 1d6) desnível ou Inclinação numa passagem.',
            'Estando a 3 metros, o Anão pode detectar (1-5 em 1d6) novo túnel/construção de passagem.',
            'Estando a 3 metros, o Anão pode detectar (1-4 em 1d6) deslizamento/deslocamento de paredes ou salas.',
            'Estando a 3 metros, o Anão pode detectar (1-3 em 1d6) armadilhas de pedra, fossos e fossos camuflados.',
            'O Anão pode determinar (1-3 em 1d6) profundidade aproximada em relação à superficie.'
          ],
          altura: { "Masculino": { minimo: 1.09, maximo: 1.33 }, "Feminino": { minimo: 1.04, maximo: 1.28 }},
          idade: { minimo: 40, maximo: 450 },
          peso: { "Masculino": { minimo: 65, maximo: 85 }, "Feminino": { minimo: 52, maximo: 72 }},
          linguas_importantes: [ "comum", "dos anões" ],
          linguas: [ "dos gnomos", "dos goblins", "dos kobolds", "dos ogros" ],
          armas_importantes: []
        },
        "Elfo": {
          "Força": { minimo: 3, maximo: 18 },
          "Destreza": { minimo: 6, maximo: 18 },
          "Constituição": { minimo: 7, maximo: 18 },
          "Inteligência": { minimo: 8, maximo: 18 },
          "Sabedoria": { minimo: 3, maximo: 18 },
          "Carisma": { minimo: 8, maximo: 18 },
          ajustes: { "Destreza": 1, "Constituição": -1 },
          detalhes: [
            'Elfos têm 90% de proteção contra magias relacionadas ao sono e magias de Encantar.',
            'Quando utilizam um arco de qualquer tipo (mas não bestas) ou quando empregam espadas (curtas ou longas) os elfos ganham um bônus de +1 em suas jogadas de ataque.',
            'Um elfo pode obter bônus de Surpresa contra seus oponentes, mas somente se não estiver usando armadura de metal. Mesmo assim, o elfo precisa estar sozinho, ou num grupo formado só de elfos ou halflings (que também não podem usar armaduras de metal), ou, no mínimo, a 30 metros de seus companheiros para ganhar o bônus. Se o elfo cumprir essas condições, os oponentes sofrerão uma penalidade de -4 em testes de Surpresa. Se uma porta ou um obstáculo precisar ser transposto, a penalidade reduz-se para -2.',
            'A infravisão permite aos elfos enxergar a 20 metros no escuro.',
            'Se estiver a 3 mestros, elfos podem localizar (1 em 1d6) portas ocultas (escondidas por uma tela, cortina ou algo parecido).',
            'Se procurar intencionalmente por uma porta secreta (construidas para não serem notadas), o elfo terá uma chance de 1-2 em 1d6 de encontrá-la.',
            'Se procurar intencionalmente por uma porta oculta (escondidas por uma tela, cortina ou algo parecido), o elfo terá uma chance de 1-3 em 1d6 de encontrá-la.'
          ],
          altura: { "Masculino": { minimo: 1.4, maximo: 1.64 }, "Feminino": { minimo: 1.27, maximo: 1.51 }},
          idade: { minimo: 100, maximo: 750 },
          peso: { "Masculino": { minimo: 45, maximo: 61 }, "Feminino": { minimo: 35, maximo: 51 }},
          linguas_importantes: [ "comum", 'élfico' ],
          linguas: [ 'dos gnomos', 'dos halflings', 'dos goblins', 'dos robgoblins', 'dos orcs', 'dos gnolls' ],
          armas_importantes: [ 'Arco longo composto', 'Arco curto composto', 'Arco longo', 'Arco curto', 'Espada longa', 'Espada curta' ]
        },
        "Gnomo": {
          "Força": { minimo: 6, maximo: 18 },
          "Destreza": { minimo: 3, maximo: 18 },
          "Constituição": { minimo: 8, maximo: 18 },
          "Inteligência": { minimo: 6, maximo: 18 },
          "Sabedoria": { minimo: 3, maximo: 18 },
          "Carisma": { minimo: 3, maximo: 18 },
          ajustes: { "Inteligência": 1, "Sabedoria": -1 },
          detalhes: [
            'Possuem um bônus de resistência (+1 para cada 3½ pontos de Constituição) contra ataques de varinhas de condão, bastão mágicos, cajados e outras magias.',
            'Gnomos têm 20% de chance de falhar toda vez que usam itens mágicos, exceto armas, armaduras, escudos, instrumentos de ilusionismo e (se o personagem é um ladrão) instrumentos que concedam ou aumentem os talentos para o roubo. Se falhar, é possível perceber se o item é amaldiçoado.',
            'Em corpo a corpo, o personagem gnomo soma 1 à sua jogada de ataque para acertar kobolds ou goblins.',
            'Quando ogros, trolls, ogros magos, gigantes ou titãs atacam os gnomos, estes monstros precisam subtrair 4 pontos de suas jogadas de ataque.',
            'A infravisão permite aos gnomos enxergar a 20 metros no escuro.',
            'Estando a 3 metros, o gnomo pode detectar (1-5 em 1d6) desnível ou Inclinação numa passagem.',
            'Estando a 3 metros, o gnomo pode detectar (1-7 em 1d10) paredes, teto e piso perigosos.',
            'O gnomo pode determinar (1-3 em 1d6) direção aproximada no subsolo.',
            'O gnomo pode determinar (1-4 em 1d6) profundidade aproximada em relação à superficie.'
          ],
          altura: { "Masculino": { minimo: 0.97, maximo: 1.13 }, "Feminino": { minimo: 0.91, maximo: 1.07 }},
          idade: { minimo: 60, maximo: 500 },
          peso: { "Masculino": { minimo: 36, maximo: 56 }, "Feminino": { minimo: 34, maximo: 54 }},
          linguas_importantes: [ "comum", "dos gnomos" ],
          linguas: [ "dos anões", "dos halflings", "dos goblins", "dos kobolds", "linguagem simples dos mamíferos que vivem em tocas (esquilos terrestres, texugos, musaranhos, doninhas, etc.)" ],
          armas_importantes: []
        },
        "Meio-Elfo": {
          "Força": { minimo: 3, maximo: 18 },
          "Destreza": { minimo: 6, maximo: 18 },
          "Constituição": { minimo: 6, maximo: 18 },
          "Inteligência": { minimo: 4, maximo: 18 },
          "Sabedoria": { minimo: 3, maximo: 18 },
          "Carisma": { minimo: 3, maximo: 18 },
          ajustes: {},
          detalhes: [
            'Meio-elfos tem 30% de proteção contra Sono e magias de Encantar.',
            'A infravisão dos meio-elfos permite-lhes enxergar a 20 metros na escuridão.',
            'Estar a 3 metros de distância de uma porta oculta (escondida por cortinas, etc.) dá ao meio-eito uma chance em seis (1 em 1d6) de localizá-la.',
            'Ao se esforçar para descobrir, ele terá uma chance em três (1-2 em 1d6) de localizar uma porta secreta (construida para ser indetectável) e uma chance em duas (1-3 em 1d6) de encontrar uma porta oculta (escondida por cortinas, etc.).'
          ],
          altura: { "Masculino": { minimo: 1.52, maximo: 1.82 }, "Feminino": { minimo: 1.47, maximo: 1.77 }},
          idade: { minimo: 15, maximo: 185 },
          peso: { "Masculino": { minimo: 55, maximo: 73 }, "Feminino": { minimo: 42, maximo: 60 }},
          linguas_importantes: [ "comum", "élfico" ],
          linguas: [ "dos gnomos", "dos halflings", "dos goblins", "dos hobgloblins", "dos orcs", "dos gnolls" ],
          armas_importantes: []
        },
        "Halfling": {
          "Força": { minimo: 7, maximo: 18 },
          "Destreza": { minimo: 7, maximo: 18 },
          "Constituição": { minimo: 10, maximo: 18 },
          "Inteligência": { minimo: 6, maximo: 18 },
          "Sabedoria": { minimo: 3, maximo: 17 },
          "Carisma": { minimo: 3, maximo: 18 },
          ajustes: { "Destreza": 1, "Força": -1 },
          detalhes: [
            'Halflings não jogam os dados para obter Força Extraordinária.',
            'Halflings têm uma grande resistência à magia. Para cada 33½  pontos de Constituição, o personagem ganha um bônus de resistênaade + 1 contra varinhas de condão, baStões, cajados e magias.',
            'Possuem resistência contra venenos. Seus testes de resistência contra veneno possuem bônus +1 para cada 3½ pontos de Constituição.',
            'Halflings ganham um bônus de +l em suas jogadas de ataque sempre que estiverem usando armas de arremesso e fundas.',
            'Um halfling pode obter bônus de Surpresa contra seus oponentes, mas somente se não estiver usando armadura de metal. Mesmo assim, o halfling precisa estar sozinho, ou num grupo formado só de elfos ou halflings (que também não podem usar armaduras de metal), ou, no mínimo, a 30 metros de seus companheiros para ganhar o bônus. Se o halfling cumprir essas condições, os oponentes sofrerão uma penalidade de -4 em testes de Surpresa. Se uma porta ou um obstáculo precisar ser transposto, a penalidade reduz-se para -2.',
          ],
          altura: { "Masculino": { minimo: 0.81, maximo: 1.21 }, "Feminino": { minimo: 0.76, maximo: 1.16 }},
          idade: { minimo: 20, maximo: 200 },
          peso: { "Masculino": { minimo: 26, maximo: 46 }, "Feminino": { minimo: 24, maximo: 44 }},
          linguas_importantes: [ "comum", "dos halflings" ],
          linguas: [ "dos anões", "élfico", "dos gnomos", "dos goblins", "dos orcs" ],
          armas_importantes: [ 'Funda', 'Dardo', 'Arco curto', 'Zarabatana' ]
        }
      };

      const TENDENCIAS = [
        "Justo (bom e leal)",
        "Ordeiro (neutro e leal)",
        "Vil (maligno e leal)",
        "Bondoso (bom e neutro)",
        "Neutro",
        "Egoista (neutro e maligno)",
        "Honrado (caótico e bom)",
        "Inconstante (neutro e caótico)",
        "Cruel (caótico e maligno)"
      ];

      const CLASSES = {
        "Guerreiro": {
          "Habilidades Exigidas": { "Força": 9 },
          "Pré-Requisitos": [ "Força" ],
          "Raças Permitidas": [ "Humano", "Anão", "Elfo", "Gnomo", "Meio-Elfo", "Halfling" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 10,
          detalhes: [
            'Um guerreiro com pontuação de 16 ou mais na Força ganha um bônus de 10% para sua experiência em pontos.'
          ]
        },
        "Paladino": {
          "Habilidades Exigidas": { "Força": 12, "Constituição": 9, "Sabedoria": 13, "Carisma": 17 },
          "Pré-Requisitos": [ "Força", "Carisma" ],
          "Raças Permitidas": [ "Humano" ],
          tendencias: [ "Justo (bom e leal)" ],
          dado_de_vida: 10,
          detalhes: [
            'Um paladino que tenha valores de Força e Carisma iguais ou maiores que 16 ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Ranger": {
          "Habilidades Exigidas": { "Força": 13, "Destreza": 13, "Constituição": 14, "Sabedoria": 14 },
          "Pré-Requisitos": [ "Força", "Destreza", "Sabedoria" ],
          "Raças Permitidas": [ "Humano", "Elfo", "Meio-Elfo" ],
          tendencias: [
            "Justo (bom e leal)",
            "Ordeiro (neutro e leal)",
            "Vil (maligno e leal)",
            "Neutro",
            "Honrado (caótico e bom)"
          ],
          dado_de_vida: 10,
          detalhes: [
            'Um ranger que tenha valores de Força. Destreza e Sabedoria iguais ou maiores que 16 ganha um bônus de 10% na experiência em pontos.'
          ]
        },
        "Mago": {
          "Habilidades Exigidas": { "Inteligência": 9 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano", "Elfo", "Meio-Elfo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um mago com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Abjurante": {
          "Habilidades Exigidas": { "Inteligência": 9, "Sabedoria": 15 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Abjurante (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Conjurador": {
          "Habilidades Exigidas": { "Constituição": 15, "Inteligência": 9 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano", "Meio-Elfo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Conjurador (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Adivinho": {
          "Habilidades Exigidas": { "Inteligência": 9, "Sabedoria": 16 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano", "Elfo", "Meio-Elfo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Adivinho (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Feiticeiro": {
          "Habilidades Exigidas": { "Inteligência": 9, "Carisma": 16 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano", "Elfo", "Meio-Elfo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Feiticeiro (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Ilusionista": {
          "Habilidades Exigidas": { "Destreza": 16, "Inteligência": 9 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano", "Gnomo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Ilusionista (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Invocador": {
          "Habilidades Exigidas": { "Constituição": 16, "Inteligência": 9 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Invocador (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Necromante": {
          "Habilidades Exigidas": { "Inteligência": 9, "Sabedoria": 16 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Necromante (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Transmutador": {
          "Habilidades Exigidas": { "Destreza": 15, "Inteligência": 9 },
          "Pré-Requisitos": [ "Inteligência" ],
          "Raças Permitidas": [ "Humano", "Meio-Elfo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 4,
          detalhes: [
            'Um Transmutador (mago especialista) com Inteligência 16 ou mais ganha um bônus de 10% em sua experiência em pontos.'
          ]
        },
        "Clérigo": {
          "Habilidades Exigidas": { "Sabedoria": 9 },
          "Pré-Requisitos": [ "Sabedoria" ],
          "Raças Permitidas": [ "Humano", "Anão", "Elfo", "Gnomo", "Meio-Elfo", "Halfling" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 8,
          detalhes: [
            'O clérigo com 16 ou mais de Sabedoria ganha um bônus de 10% em sua experiência.',
            'Um clérigo de um mito específico deve possuir uma tendência aceitável para a divindade'
          ]
        },
        "Druida": {
          "Habilidades Exigidas": { "Sabedoria": 12, "Carisma": 15 },
          "Pré-Requisitos": [ "Sabedoria", "Carisma" ],
          "Raças Permitidas": [ "Humano", "Meio-Elfo" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 8,
          detalhes: [
            'Um druida com pontuação de 16 ou mais em Sabedoria e Carisma ganha um bônus de 10% para sua experiência em pontos.'
          ]
        },
        "Ladrão": {
          "Habilidades Exigidas": { "Destreza": 9 },
          "Pré-Requisitos": [ "Destreza" ],
          "Raças Permitidas": [ "Humano", "Anão", "Elfo", "Gnomo", "Meio-Elfo", "Halfling" ],
          tendencias: TENDENCIAS,
          dado_de_vida: 6,
          detalhes: [
            'O ladrão com 16 ou mais de Destreza ganha um bônus de 10% em sua experiência.'
          ]
        },
        "Bardo": {
          "Habilidades Exigidas": { "Destreza": 12, "Inteligência": 13, "Carisma": 15 },
          "Pré-Requisitos": [ "Destreza", "Carisma" ],
          "Raças Permitidas": [ "Humano", "Meio-Elfo" ],
          tendencias: [
            "Ordeiro (neutro e leal)",
            "Bondoso (bom e neutro)",
            "Neutro",
            "Egoista (neutro e maligno)",
            "Inconstante (neutro e caótico)"
          ],
          dado_de_vida: 6,
          detalhes: [
            'O bardo com 16 ou mais de Destreza e Carisma ganha um bônus de 10% em sua experiência.'
          ]
        }
      };

      function rolar1d6(callback) {
        let resultado = Math.floor(Math.random() * 6) + 1;
        callback(resultado);
      }

      function rolar1d100(callback) {
        let resultado = Math.floor(Math.random() * 100) + 1;
        callback(resultado);
      }

      function rolar3d6(callback) {
        rolar1d6(dado1 => {
          rolar1d6(dado2 => {
            rolar1d6(dado3 => {
              let resultado = dado1 + dado2 + dado3;
              callback(resultado);
            })
          })
        })
      }

      function sortear_atributos(callback) {
        rolar3d6(forca => {
          rolar3d6(destreza => {
            rolar3d6(constituicao => {
              rolar3d6(inteligencia => {
                rolar3d6(sabedoria => {
                  rolar3d6(carisma => {
                    callback({
                      "Raça": '',
                      "Classe": '',
                      "Tendência": '',
                      "Dados Básicos": {
                        "Dados de Vida": 0,
                        "Gênero": '',
                        "Idade": 0,
                        "Altura": 0,
                        "Peso": 0
                      },
                      "Habilidades": {
                        "Força": { "Valor da Habilidade": forca },
                        "Destreza": { "Valor da Habilidade": destreza },
                        "Constituição": { "Valor da Habilidade": constituicao },
                        "Inteligência": { "Valor da Habilidade": inteligencia },
                        "Sabedoria": { "Valor da Habilidade": sabedoria },
                        "Carisma": { "Valor da Habilidade": carisma },
                      },
                      "Idiomas": [],
                      "Detalhes": []
                    });
                  });
                });
              });
            });
          });
        });
      }

      function validar_habilidades(personagem, callback) {

        let keys_racas = Object.keys(RACAS);
        let keys_habilidades = Object.keys(personagem["Habilidades"]);

        let racas = [];

        keys_racas.forEach((raca,index_racas) => {

          let habilidade_valida = true;
          keys_habilidades.forEach((habilidade,index_habilidades) => {
              let valor = personagem["Habilidades"][habilidade]["Valor da Habilidade"];
              let limites = RACAS[raca][habilidade];
              if ( (valor < limites["minimo"]) || (valor > limites["maximo"]) ) {
                habilidade_valida = false;
              }

              if (index_habilidades == (keys_habilidades.length - 1)) {
                if (habilidade_valida) {
                  racas.push(raca);
                }
              }
          });

          if (index_racas == (keys_racas.length - 1)) {
            callback(racas);
          }
        });

      }

      function ajustar_nome_raca(personagem) {
        let raca = personagem["Raça"];
        if ( (raca.indexOf('Elfo') > -1) || (raca.indexOf('Drow') > -1) ) {
          raca = 'Elfo';
        }
        if (raca.indexOf('Halfling') > -1) {
          raca = 'Halfling';
        }
        return raca;
      }

      function sortear_raca(personagem, callback) {
        validar_habilidades(personagem, racas => {
          let index = Math.floor(Math.random() * racas.length);
          let raca = racas[index];
          personagem["Raça"] = raca;

          if (raca == "Elfo") {
            let racas_elficas = [
              'Elfo (Alto-Elfo)', 'Elfo (Alto-Elfo)', 'Elfo (Alto-Elfo)', 'Elfo (Alto-Elfo),',
              'Elfo Aquático', 'Elfo Cinzento', 'Elfo da Floresta', 'Drow'
            ];
            personagem["Raça"] = racas_elficas[Math.floor(Math.random() * racas_elficas.length)];
          }

          if (raca == "Halfling") {
            let racas_halflings = [ 'Halfling Pespeludos', 'Halfling Tiposaltos', 'Halfling Robustos' ];
            personagem["Raça"] = racas_halflings[Math.floor(Math.random() * racas_halflings.length)];
          }

          let ajustes = Object.keys(RACAS[raca].ajustes);
          if (ajustes.length == 0) {
            callback();
          } else {
            ajustes.forEach((habilidade, i) => {

              let valor = personagem["Habilidades"][habilidade]["Valor da Habilidade"];
              let ajuste = RACAS[raca].ajustes[habilidade];
              personagem["Habilidades"][habilidade]["Valor da Habilidade"] = valor + ajuste;

              if (i == (ajustes.length - 1)) {
                callback();
              }
            });
          }

        });
      }

      function validar_classes_por_habilidades(classes, personagem, callback) {
        let keys_classes = classes;
        let keys_habilidades = Object.keys(personagem["Habilidades"]);
        let classes_permitidas = [];

        keys_classes.forEach((classe,index_classes) => {

          let habilidade_valida = true;
          keys_habilidades.forEach((habilidade,index_habilidades) => {
              let valor = personagem["Habilidades"][habilidade]["Valor da Habilidade"];
              let limite = CLASSES[classe]["Habilidades Exigidas"][habilidade];
              if (valor < limite) {
                habilidade_valida = false;
              }

              if (index_habilidades == (keys_habilidades.length - 1)) {
                if (habilidade_valida) {
                  classes_permitidas.push(classe);
                }
              }
          });

          if (index_classes == (keys_classes.length - 1)) {
            callback(classes_permitidas);
          }
        });
      }

      function validar_classes_por_raca(personagem, callback) {
        let keys_classes = Object.keys(CLASSES);
        let classes_permitidas = [];

        keys_classes.forEach((classe,index_classes) => {
          let keys_racas = CLASSES[classe]["Raças Permitidas"];
          let classe_permitida = false;

          keys_racas.forEach((raca, index_classe_permitida) => {
            if (ajustar_nome_raca(personagem) == raca) {
              classe_permitida = true;
            }

            if (index_classe_permitida == (keys_racas.length - 1)) {
              if (classe_permitida) {
                classes_permitidas.push(classe);
              }
            }
          });

          if (index_classes == (keys_classes.length - 1)) {
            callback(classes_permitidas);
          }
        });
      }

      function sortear_classe(personagem, callback) {
        validar_classes_por_raca(personagem, classes => {
          validar_classes_por_habilidades(classes, personagem, classes_permitidas => {
            if (classes_permitidas.length == 0) {
              callback({ valores_invalidos: true });
            } else {
              let classes_fortes = ["Paladino", "Ranger", "Abjurante", "Conjurador", "Adivinho", "Feiticeiro", "Ilusionista", "Invocador", "Necromante", "Transmutador", "Druida", "Bardo"];
              let classes_selecionadas = [];
              classes_fortes.forEach((classe_forte, index_classes_fortes) => {
                classes_permitidas.forEach((classe_permitida, index_classe_permitida) => {
                  if (classe_permitida == classe_forte) {
                    classes_selecionadas.push(classe_permitida);
                  }
                });

                if (index_classes_fortes == (classes_fortes.length - 1)) {

                  if (classes_selecionadas.length > 0) {

                    let index = Math.floor(Math.random() * classes_selecionadas.length);
                    personagem["Classe"] = classes_selecionadas[index];

                  } else {

                    let index = Math.floor(Math.random() * classes_permitidas.length);
                    let classe_final = classes_permitidas[index];

                    if (classe_final == "Clérigo") {
                      let lista_clerigos = [
                        "Clérigo", "Clérigo", "Clérigo", "Clérigo",
                        "Clérigo", "Clérigo", "Clérigo", "Clérigo",
                        "Clérigo", "Clérigo", "Clérigo", "Clérigo",
                        "Clérigo", "Clérigo", "Clérigo", "Clérigo",
                        "Clérigo", "Clérigo", "Clérigo", "Clérigo",
                        "Clérigo da Agricultura",
                        "Clérigo dos Ferreiros",
                        "Clérigo da Morte",
                        "Clérigo da Doença",
                        "Clérigo da Terra",
                        "Clérigo da Cura",
                        "Clérigo da Caça",
                        "Clérigo do Relâmpago",
                        "Clérigo do Amor",
                        "Clérigo da Natureza",
                        "Clérigo dos Oceanos",
                        "Clérigo da Paz",
                        "Clérigo da Força",
                        "Clérigo do Trovão",
                        "Clérigo da Guerra",
                        "Clérigo dos Ventos"
                      ];
                      let index_clerigo = Math.floor(Math.random() * lista_clerigos.length);
                      classe_final = lista_clerigos[index_clerigo];
                    }

                    personagem["Classe"] = classe_final;
                  }

                  callback({ valores_invalidos: false });
                }
              });
            }
          });
        });
      }

      function render() {
        obter_dados_personagem(personagem => {
          let output = document.getElementById('ficha');
          var node = prettyPrint(personagem);
          document.getElementById('ficha').appendChild(node);
        });
      }

      function sortear_personagem(callback) {
        sortear_atributos(personagem => {
          sortear_raca(personagem, () => {
            sortear_classe(personagem, resultado => {
              if (resultado.valores_invalidos) {
                sortear_personagem(personagem => {
                  console.log("Foi necessário outro lance de dados pois não foi possível escolher uma classe.");
                  sortear_tendencia(personagem, () => {
                    sortear_dados_basicos(personagem, () => {
                      callback(personagem);
                    });
                  });
                });
              } else {
                sortear_tendencia(personagem, () => {
                  sortear_dados_basicos(personagem, () => {
                    callback(personagem);
                  });
                });
              }
            });
          });
        });
      }

      function ajustar_nome_classe(personagem) {
        let classe = personagem["Classe"];
        if (classe.indexOf('Clérigo') > -1) {
          classe = 'Clérigo';
        }
        return classe;
      }

      function sortear_tendencia(personagem, callback) {
        let classe = ajustar_nome_classe(personagem);
        let tendencias = CLASSES[classe].tendencias;
        let index = Math.floor(Math.random() * tendencias.length);
        personagem["Tendência"] = tendencias[index];
        callback();
      }

      function sortear_dados_basicos(personagem, callback) {
        let classe = ajustar_nome_classe(personagem);
        let raca = ajustar_nome_raca(personagem);

        let vida = Math.floor(Math.random() * CLASSES[classe].dado_de_vida) + 1;
        personagem["Dados Básicos"]["Dados de Vida"] = vida;

        let generos = [ 'Masculino' , 'Feminino' ];
        let genero = generos[Math.floor(Math.random() * 2)];
        personagem["Dados Básicos"]["Gênero"] = genero;

        let ajuste_altura = RACAS[raca].altura[genero].maximo - RACAS[raca].altura[genero].minimo;
        let altura = (Math.random() * ajuste_altura) + RACAS[raca].altura[genero].minimo;
        personagem["Dados Básicos"]["Altura"] = altura.toFixed(2);

        let ajuste_idade = RACAS[raca].idade.maximo - RACAS[raca].idade.minimo;
        let idade = Math.floor(Math.random() * ajuste_idade) + RACAS[raca].idade.minimo;
        personagem["Dados Básicos"]["Idade"] = idade;

        let ajuste_peso = RACAS[raca].peso[genero].maximo - RACAS[raca].peso[genero].minimo;
        let peso = (Math.random() * ajuste_peso) + RACAS[raca].peso[genero].minimo;
        personagem["Dados Básicos"]["Peso"] = peso.toFixed(2);

        personagem["Idiomas"] = RACAS[raca].linguas_importantes;

        personagem["Detalhes"] = RACAS[raca].detalhes;

        if (personagem["Raça"].indexOf('Halfling') > -1) {

          let detalheRobusto = 'Qualquer Halfling Robusto puro tem 15% de chance de ter uma infravisão normal, até 20 metros.';
          let detalheNaoRobustos = 'Halflings que não são Robustos puros, tem 25% de chance de ter uma infravisão limitada, até 10 metros.';
          let resultadoDado = 0;

          if (personagem["Raça"] == 'Halfling Robustos') {

            personagem["Detalhes"].push('Halflings com sangue Robusto podem notar o desnível de uma passagem com 75% de precisão (1-3 em 1d4).');
            personagem["Detalhes"].push('Halflings com sangue Robusto podem determinar a direção com 50% de eficiência (1-3 em 1d6).');

            resultadoDado = Math.floor(Math.random() * 100);
            if (resultadoDado < 15) {
              personagem["Detalhes"].push(detalheRobusto);
            } else {
              resultadoDado = Math.floor(Math.random() * 100);
              if (resultadoDado < 25) {
                personagem["Detalhes"].push(detalheNaoRobustos);
              }
            }
          } else {
            resultadoDado = Math.floor(Math.random() * 100);
            if (resultadoDado < 25) {
              personagem["Detalhes"].push(detalheNaoRobustos);
            }
          }
        }

        callback();
      }

      function obter_dados_personagem(callback) {
        let urlParams = new URLSearchParams(window.location.search);
        let h = urlParams.get('h');
        let raca = urlParams.get('r');
        let habilidades = [];

        // ?h=10,11,12,13,14,15&r=Anão
        if ( (h != undefined) && (h != null) && (h != '') && (h.length > 0) && (h.split(',').length == 6) ) {
          let hs = h.split(',');
          let personagem = {
            "Habilidades": {
              "Força": { "Valor da Habilidade": parseInt(hs[0]) },
              "Destreza": { "Valor da Habilidade": parseInt(hs[1]) },
              "Constituição": { "Valor da Habilidade": parseInt(hs[2]) },
              "Inteligência": { "Valor da Habilidade": parseInt(hs[3]) },
              "Sabedoria": { "Valor da Habilidade": parseInt(hs[4]) },
              "Carisma": { "Valor da Habilidade": parseInt(hs[5]) },
            },
            "Raça": raca
          };
          callback(personagem);
        } else {
          sortear_personagem(personagem => {
            callback(personagem);
          });
        }
      }

      render();

    </script>
  </body>
</html>
